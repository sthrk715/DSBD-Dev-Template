# テスト戦略

## テストライブラリ

| 種別 | ライブラリ | 用途 |
|------|----------|------|
| Unit / Integration | Vitest | ユニットテスト、結合テスト |
| E2E | Playwright | ブラウザE2Eテスト |
| カバレッジ | @vitest/coverage-v8 | カバレッジ計測 |

## テストピラミッド

| テスト種別 | 比率 | 実行時間目標 | 実行タイミング |
|-----------|------|------------|--------------|
| Unit Test | 65〜80% | 全体5分以内 | コミットごと |
| Integration Test | 15〜25% | 全体15分以内 | PR作成時 |
| E2E Test | 5〜10% | 全体30分以内 | デプロイ前 |

## カバレッジ基準

| メトリクス | 最低基準 | 推奨目標 |
|-----------|--------|---------|
| 行カバレッジ | 70% | 80%以上 |
| 分岐カバレッジ | 60% | 75%以上 |
| クリティカルモジュール（認証・データ処理） | 85% | 90%以上 |
| 新規コード（差分） | 80% | 90%以上 |

## モック/スタブ方針

| 対象 | 方針 | 理由 |
|------|------|------|
| BigQueryクライアント | モック | 実際のBQに課金しない |
| Cloud SQL | テスト用DBコンテナ (docker compose) | リアルなDB挙動を検証 |
| 外部API | MSW (Mock Service Worker) でスタブ | ネットワーク依存を排除 |
| NextAuth | モック | 認証フローを簡略化 |

## TDDワークフロー

```
1. Red   → テストを先に書く（テスト失敗を確認）
2. Green → テストが通る最小限の実装
3. Refactor → コード品質の改善（テストは通ったまま）
4. Verify → 全テストがパスすることを確認
```

## セキュリティテスト

| テスト種別 | タイミング | ツール | ゲート基準 |
|-----------|----------|--------|----------|
| SAST | コミットごと | Semgrep, CodeQL | Critical/High = 0 |
| SCA | コミットごと + 日次 | Snyk, Trivy, Dependabot | Critical/High = 0 |
| DAST | リリース前 + 週次 | OWASP ZAP | Critical/High = 0 |
| シークレットスキャン | コミットごと | Gitleaks, TruffleHog | 検出 = 0 |
| コンテナスキャン | ビルドごと | Trivy | Critical/High = 0 |

## 性能テスト

| テスト種別 | 頻度 | 判定基準 |
|-----------|------|---------|
| 負荷テスト | リリース前 | p95がSLO以内、想定ピーク2倍に耐える |
| ストレステスト | 四半期 | 限界点の特定、グレースフルデグラデーション |
| 耐久テスト | 月次 | メモリリーク等の長期問題なし |
