# 機能要件定義書

## 画面一覧

| 画面ID | 画面名 | URL | 認証 | 概要 |
|--------|--------|-----|------|------|
| SCR-001 | ログイン | /login | 不要 | Google SSO認証 |
| SCR-002 | ダッシュボード | /dashboard | 要 | 9タブ構成のメインダッシュボード |
| SCR-003 | ユーザー管理 | /settings/users | 要（Admin） | ユーザー招待・権限付与・削除 |
| SCR-004 | システム設定 | /settings/system | 要（Admin） | 通知設定等 |

## 画面別機能定義

### SCR-001: ログイン画面

**設計書:** `docs/02_design/auth-design.md`

- [ ] Google OAuth 2.0 SSO認証（「Googleでログイン」ボタン）
- [ ] 未認証ユーザーの自動リダイレクト（/login へ）
- [ ] ログイン失敗時のエラー表示
- [ ] ログイン後のリダイレクト（元のURL or /dashboard）

### SCR-002: ダッシュボード

**設計書:** `docs/02_design/dashboard-ui-spec.md`

9タブ構成のメインダッシュボード。全タブ共通のフィルタバーを上部に配置。

#### 共通フィルタバー（全タブ共通）

- [ ] 期間選択 DateRangePicker（プリセット: 直近7日/30日/90日/当月/前月/当四半期/当年度/カスタム。デフォルト: 直近30日）
- [ ] チャネル選択 FilterSelect（全体/Shopify/Amazon/楽天/Yahoo!）
- [ ] 表示期間切替 PeriodSelector（日次/週次/月次）
- [ ] 比較モード切替（暦日比較/同曜日比較）
- [ ] リセットボタン
- [ ] フィルタ状態のURL連動（ブックマーク可能）
- [ ] データエクスポート（CSV）

#### タブ1: エグゼクティブサマリ

- [ ] KPIカード表示（全チャネル合計売上/目標達成率/前年比/注文件数）
  - 前期比（%）+ トレンドアイコン（↑↓→）
  - データソース: `mart.daily_sales_summary`, `mart.sales_targets`
- [ ] 日次売上推移グラフ（折れ線: 当年 vs 前年 + 棒: 日次売上）
  - イベントフラグ付き（販促イベント・アドホックイベントをオーバーレイ表示）
  - データソース: `mart.time_series_comparison`, `mart.event_enriched_daily`
- [ ] チャネル別売上構成比（ドーナツチャート）
- [ ] チャネル別KPIテーブル（チャネル/売上/注文数/客単価/前年比）

#### タブ2: チャネル別詳細

- [ ] チャネル別売上・注文数・客単価の比較テーブル
- [ ] チャネル別売上推移グラフ（折れ線、チャネルごとに色分け）
- [ ] チャネル別構成比推移（面グラフ）
- [ ] データソース: `mart.daily_sales_summary`

#### タブ3: サブスク分析

- [ ] KPIカード（アクティブ契約数/当月新規契約数/解約率/一時停止率/スキップ率）
  - データソース: `mart.subscription_analysis`
- [ ] 契約者数推移（面グラフ: アクティブ/一時停止/解約）
- [ ] コホート分析ヒートマップ（横: 経過月数、縦: コホート月、値: リテンション率）
  - データソース: `mart.subscription_cohort`
- [ ] 月次解約率推移（折れ線グラフ）
- [ ] 年度別比較テーブル（年度別新規/継続の契約者数）
- [ ] サブスク売上推移 + ARPU

#### タブ4: 顧客分析

- [ ] 新規/リピーター売上比率（積み上げ棒グラフ）
- [ ] 客単価比較（新規 vs リピーター）
- [ ] F2転換率推移（折れ線グラフ）
- [ ] チャネル別新規/リピーター構成比
- [ ] データソース: `mart.customer_analysis`

#### タブ5: アクセス・CVR分析

- [ ] GA4セッション数推移（流入元別: 検索/直接/広告/自社APP）
- [ ] 商品ページ別CVR（テーブル + ソート）
- [ ] 流入元分析（チャネル別セッション構成比）
- [ ] 自社EC CVR推移（折れ線グラフ）
- [ ] データソース: `mart.access_analysis`
- [ ] 注: 楽天/Yahoo!のアクセスデータはCSV手動取込（R-Karte/ストアクリエイターPro）

#### タブ6: ギフト売上

- [ ] シーズンセレクタ（母の日/中元/敬老の日/歳暮/福箱/全て）
- [ ] KPIカード（シーズン累計売上/前年比/eギフト比率/残り日数）
- [ ] シーズン内日次売上推移（当年 vs 前年累計比較）
- [ ] ギフトシーズン横断比較テーブル
- [ ] eギフト vs 物理ギフト構成比
- [ ] ギフトシーズン進捗ゲージ（累計 + 前年ペースバー）
- [ ] データソース: `mart.gift_seasonal_sales`, `mart.gift_season_master`

#### タブ7: 商品カテゴリ別売上

- [ ] カテゴリ別売上構成比（ドーナツチャート or ツリーマップ）
- [ ] 注力商品追跡テーブル（商品名/売上/前年比/構成比）
- [ ] カテゴリ別売上推移（折れ線グラフ）
- [ ] カスケードフィルタ（チャネル選択 → そのチャネルの商品のみ表示）
- [ ] データソース: `mart.product_category_sales`

#### タブ8: メルマガ分析

- [ ] 配信実績テーブル（配信日/件名/配信数/開封率/クリック率/売上貢献）
- [ ] 開封率/クリック率推移（折れ線グラフ）
- [ ] 配信リスト数推移
- [ ] 売上貢献分析
- [ ] データソース: `mart.email_campaign_analysis`
- [ ] 注: 楽天R-Mail/Yahoo! STORE's R∞はCSV手動取込

#### タブ9: 時系列比較

- [ ] 比較モード選択（前年比/前月比/前週比/同曜日比/前々年比）
- [ ] 比較グラフ（当期 vs 比較期の折れ線重ね合わせ）
- [ ] 移動平均表示（7日/28日移動平均のトグル）
- [ ] 月初来累計（MTD）/ 期初来累計（YTD、4月始まり）
- [ ] イベントフラグ付き時系列（販促イベントをオーバーレイ表示）
- [ ] データソース: `mart.time_series_comparison`, `mart.event_enriched_daily`

### SCR-003: ユーザー管理画面（Admin専用）

**設計書:** `docs/02_design/permission-management.md`

- [ ] ユーザー一覧テーブル（名前/メール/ロール/状態/最終ログイン）
- [ ] 検索・フィルタ（テキスト検索、ロール、ステータス）
- [ ] ユーザー招待モーダル（メール/名前/ロール選択）
  - Google SSO招待: ログインURLをメール送信
- [ ] ロール変更（Admin ↔ Viewer、確認ダイアログ付き）
  - 自分自身のロール変更は不可
  - 最後のAdminのロール降格は不可
- [ ] アカウント無効化（ソフトデリート）
- [ ] ユーザー削除（メールアドレス入力で確認）
- [ ] ページネーション

### SCR-004: システム設定（Admin専用）

- [ ] Slack通知設定（Webhook URL、通知チャネル）
- [ ] 日次サマリ通知の有効/無効
- [ ] 閾値アラート設定（KPIごとの閾値）
- [ ] イベントカレンダー管理（販促イベント・アドホックイベントの登録/編集/削除）
- [ ] 売上目標管理（月次/チャネル別の売上目標の登録/編集）
- [ ] ギフトシーズン定義の編集（シーズン名/開始日/終了日）

## ユーザー権限と認証方式

### 認証方式

| 方式 | 対象 | 実装 |
|------|------|------|
| Google SSO (OAuth 2.0) | 全ユーザー（Google Workspaceドメイン制限） | NextAuth.js Google Provider |

### ロール定義

| ロール | 説明 | 権限 |
|--------|------|------|
| Admin | 管理者 | 全データ閲覧、フィルタ操作、データエクスポート、ユーザー管理（招待・権限付与）、システム設定 |
| Viewer | 閲覧者 | 全データ閲覧、フィルタ操作、データエクスポート |

### 権限マトリクス

| 機能 | Admin | Viewer |
|------|-------|--------|
| ダッシュボード閲覧（全9タブ） | ○ | ○ |
| フィルタ操作 | ○ | ○ |
| データエクスポート（CSV） | ○ | ○ |
| ユーザー招待・管理 | ○ | × |
| ロール変更 | ○ | × |
| システム設定 | ○ | × |
| イベントカレンダー管理 | ○ | × |
| 売上目標管理 | ○ | × |
| ギフトシーズン定義編集 | ○ | × |

## データ更新頻度

| データ種別 | 更新頻度 | 方式 | ETL参照 |
|-----------|---------|------|---------|
| Shopify注文/顧客 | 日次 (AM 3:00) | Trocco (Native) → BigQuery | `docs/02_design/bigquery-etl-design.md` |
| 楽天注文 | 日次 (AM 3:30) | Trocco (HTTP) → BigQuery | 同上 |
| Yahoo!注文 | 日次 (AM 4:00) | Trocco (HTTP) → BigQuery | 同上 |
| Amazon注文/トラフィック | 日次 (AM 4:30) | Fivetran (Free) → BigQuery | 同上 |
| GA4イベント | 日次 (AM 5:00) | GA4 BigQuery Export | 同上 |
| Raw → Staging変換 | 日次 (AM 7:00) | BigQuery Scheduled Query | 同上 |
| Staging → Mart集計 | 日次 (AM 7:30) | BigQuery Scheduled Query | 同上 |
| ダッシュボード更新完了 | AM 8:00 | キャッシュ更新 + Slack通知 | 同上 |
| R-Karte / R-Mail CSV | 手動（不定期） | GCS → Trocco CSV → BigQuery | 同上 |
| イベントマスタ / 売上目標 | 手動（Admin操作） | ダッシュボード管理画面 → BigQuery | 同上 |

## マルチテナント要件

- マルチテナント: 不要（単一テナント）
- データ分離方式: 該当なし

## 通知機能

| 通知種別 | トリガー | 通知先 |
|---------|---------|--------|
| 日次サマリ | 毎朝AM 8:00（データ更新完了時） | Slack |
| 閾値アラート | KPIが設定閾値を超過/下回った場合 | Slack |
| ETLエラー | データ取込の失敗 | Slack |
| ユーザー招待 | Adminが招待実行 | 招待対象のメール |
| ロール変更通知 | Adminがロール変更 | 対象ユーザーのメール |
