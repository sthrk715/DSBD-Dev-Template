# 運用ランブック

## インシデント重大度分類（ITIL準拠）

| レベル | 条件 | 初動目標 | 復旧目標 |
|--------|------|---------|---------|
| P1 緊急 | サービス全停止 / データ漏洩 | 15分以内 | 1時間以内 |
| P2 重大 | 主要機能障害 | 30分以内 | 4時間以内 |
| P3 中度 | 軽微な障害、回避策あり | 2時間以内 | 翌営業日 |
| P4 低度 | 外観上の問題 | 翌営業日 | 次回リリース |

## 障害パターン別対応手順

### 1. Cloud Runインスタンス起動失敗

**症状:** 502/503エラー、ヘルスチェック失敗
**対応手順:**
1. Cloud Loggingでコンテナログを確認
   ```bash
   gcloud logging read "resource.type=cloud_run_revision AND severity>=ERROR" --limit=50
   ```
2. 直近のデプロイ変更を確認
3. 原因に応じた対応:
   - 環境変数不足 → Secret Manager確認
   - メモリ不足 → Cloud Run設定でメモリ増量
   - コードバグ → 前バージョンにロールバック

### 2. BigQueryクエリタイムアウト

**症状:** API応答遅延、タイムアウトエラー
**対応手順:**
1. Cloud ConsoleのBigQueryジョブ一覧で実行中クエリを確認
2. INFORMATION_SCHEMAでスキャン量を確認
3. 対応:
   - 一時的な負荷 → クエリキャンセル + キャッシュクリア
   - クエリ非効率 → マテリアライズドビュー / パーティション見直し
   - スロット不足 → オンデマンドスロット追加

### 3. 認証エラー多発

**症状:** ログインエラー率上昇
**対応手順:**
1. Cloud Loggingで認証エラーログを確認
2. 原因特定:
   - OAuth設定 → Google Cloud Console確認
   - トークン/証明書期限 → 期限確認・更新
   - 攻撃 → IP制限・レート制限強化

### 4. メモリ不足 (OOM)

**症状:** Cloud Runインスタンスの再起動
**対応手順:**
1. Cloud Monitoringでメモリ使用量推移を確認
2. 対応:
   - Cloud Run設定でメモリを増量（即時対応）
   - メモリリークの調査（恒久対応）

## コスト異常時の対応

**トリガー:** BigQueryスキャン量が日平均の3倍超過
**対応:**
1. BigQuery INFORMATION_SCHEMA でクエリジョブを確認
2. 異常なクエリ（全テーブルスキャン等）を特定
3. クエリの最適化 or パーティションフィルタ追加
4. 必要に応じてクエリのキャンセル

## 定期メンテナンス

| 項目 | 頻度 | 手順 |
|------|------|------|
| 依存パッケージ更新 | 月次 | Dependabot PR確認→テスト→マージ |
| SSL証明書更新 | 自動（Let's Encrypt） | 失敗時は手動更新 |
| DBバキューム | 週次（自動） | Cloud SQL自動メンテナンス |
| ログローテーション | 自動 | Cloud Loggingの保持ポリシー |
| バックアップ検証 | 四半期 | リストア訓練実施 |

## 脆弱性管理（CVSSベース）

| CVSS | 重大度 | 対応期限 |
|------|--------|---------|
| 9.0-10.0 | Critical | 72時間以内 |
| 7.0-8.9 | High | 1週間以内 |
| 4.0-6.9 | Medium | 1ヶ月以内 |
| 0.1-3.9 | Low | 次回定期メンテナンス |
