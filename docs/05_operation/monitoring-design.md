# 監視設計書

## Observability三本柱

### Logs（ログ）

- 形式: 構造化ログ（JSON）
- 出力先: Cloud Logging
- 必須フィールド:

```json
{
  "timestamp": "2026-01-01T00:00:00.000Z",
  "level": "INFO|WARN|ERROR",
  "service": "dsbd-app",
  "traceId": "abc123",
  "spanId": "def456",
  "message": "ログメッセージ",
  "userId": "user-id（マスク済み）",
  "path": "/api/dashboards",
  "method": "GET",
  "statusCode": 200,
  "duration": 150
}
```

- 保存期間: Hot 30日 / Warm 90日 / Cold 1年以上
- **禁止:** 個人情報・機密情報のログ出力（マスキング処理必須）

### Metrics（メトリクス）

**RED法（サービスメトリクス）:**
| メトリクス | 対象 | 収集間隔 |
|-----------|------|---------|
| Rate | リクエスト数/秒 | 15秒 |
| Errors | エラーレート (%) | 15秒 |
| Duration | レスポンスタイム (p50/p95/p99) | 15秒 |

**USE法（インフラメトリクス）:**
| メトリクス | 対象 | 収集間隔 |
|-----------|------|---------|
| Utilization | CPU/メモリ使用率 | 60秒 |
| Saturation | キュー長、接続プール使用率 | 60秒 |
| Errors | インフラエラー | 60秒 |

### Traces（トレース）

- 準拠: W3C Trace Context
- サンプリングレート: 通常1〜10% / エラー時100%
- ツール: Cloud Trace

## 監視対象メトリクス

### Cloud Run
| メトリクス | 閾値 |
|-----------|------|
| リクエスト数 | ベースライン監視 |
| レイテンシ (p95) | < 3秒 |
| エラーレート | < 5% |
| インスタンス数 | [TODO: 最大値] |
| メモリ使用率 | < 80% |
| CPU使用率 | < 70% |

### BigQuery
| メトリクス | 閾値 |
|-----------|------|
| クエリ実行時間 | < [TODO: 30秒] |
| スキャン量 | [TODO: 月間上限] |
| スロット使用量 | ベースライン監視 |
| クエリ失敗数 | = 0 |

### Cloud SQL
| メトリクス | 閾値 |
|-----------|------|
| 接続数 | < [TODO: 最大接続数の80%] |
| CPU使用率 | < 80% |
| メモリ使用率 | < 80% |
| ストレージ使用量 | < 80% |
