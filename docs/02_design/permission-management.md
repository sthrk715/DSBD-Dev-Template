# æ¨©é™ç®¡ç†ãƒšãƒ¼ã‚¸ å®šç¾©ãƒ»è¨­è¨ˆãƒ»å®Ÿè¡Œã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

Admin ãƒ­ãƒ¼ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªæ¨©é™ç®¡ç†ãƒšãƒ¼ã‚¸ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‹›å¾…ãƒ»ãƒ­ãƒ¼ãƒ«å¤‰æ›´ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–ã‚’è¡Œã†ã€‚

**ã‚¢ã‚¯ã‚»ã‚¹URL:** `/settings/users`
**å¿…è¦ãƒ­ãƒ¼ãƒ«:** ADMIN ã®ã¿

---

## ç”»é¢æ§‹æˆ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ (SCR-004-A: /settings/users)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† è¨­å®š]  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢... â”‚  â”‚ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‹›å¾…          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  ãƒ­ãƒ¼ãƒ«: [ã™ã¹ã¦ â–¼]  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: [ã™ã¹ã¦ â–¼]              â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ åå‰          â”‚ ãƒ¡ãƒ¼ãƒ«           â”‚ ãƒ­ãƒ¼ãƒ« â”‚ çŠ¶æ…‹  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ å±±ç”° å¤ªéƒ     â”‚ yamada@ex.com   â”‚ Admin  â”‚ æœ‰åŠ¹  â”‚  â”‚
â”‚  â”‚ ä½è—¤ èŠ±å­     â”‚ sato@ex.com     â”‚ Editor â”‚ æœ‰åŠ¹  â”‚  â”‚
â”‚  â”‚ éˆ´æœ¨ ä¸€éƒ     â”‚ suzuki@ex.com   â”‚ Viewer â”‚ æœ‰åŠ¹  â”‚  â”‚
â”‚  â”‚ ç”°ä¸­ æ¬¡éƒ     â”‚ tanaka@ex.com   â”‚ Viewer â”‚ æ‹›å¾…ä¸­â”‚  â”‚
â”‚  â”‚ æ æ˜         â”‚ lee@partner.com â”‚ Viewer â”‚ ãƒ­ãƒƒã‚¯â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  1-5 / 12ä»¶  [< å‰ã¸] [1] [2] [3] [æ¬¡ã¸ >]              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‹›å¾…                [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ user@example.com             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â”‚
â”‚  åå‰                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â”‚
â”‚  ãƒ­ãƒ¼ãƒ« *                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Viewer                    â–¼  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â€» Viewer: é–²è¦§ã®ã¿                 â”‚
â”‚  â€» Editor: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆãƒ»ç·¨é›†å¯ â”‚
â”‚  â€» Admin: å…¨æ©Ÿèƒ½ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†      â”‚
â”‚                                      â”‚
â”‚  èªè¨¼æ–¹å¼ *                           â”‚
â”‚  â—‹ Google SSOï¼ˆç¤¾å†…ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰     â”‚
â”‚  â— Email & Password                  â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ã‚­ãƒ£ãƒ³ã‚»ãƒ« â”‚  â”‚  æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ»ãƒ­ãƒ¼ãƒ«å¤‰æ›´ãƒ‘ãƒãƒ«ï¼ˆè¡Œã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ãƒãƒ«ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°              [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                   â”‚
â”‚  [ã‚¢ãƒã‚¿ãƒ¼]  å±±ç”° å¤ªéƒ             â”‚
â”‚  yamada@example.com               â”‚
â”‚  èªè¨¼æ–¹å¼: Google SSO              â”‚
â”‚                                   â”‚
â”‚  â”€â”€ ãƒ­ãƒ¼ãƒ«è¨­å®š â”€â”€                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Admin                 â–¼  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  [å¤‰æ›´ã‚’ä¿å­˜]                      â”‚
â”‚                                   â”‚
â”‚  â”€â”€ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ â”€â”€              â”‚
â”‚  çŠ¶æ…‹: æœ‰åŠ¹                        â”‚
â”‚  æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: 2026-02-22 10:30   â”‚
â”‚  ä½œæˆæ—¥: 2026-01-01               â”‚
â”‚  æ‹›å¾…è€…: -ï¼ˆè‡ªå·±ç™»éŒ²ï¼‰             â”‚
â”‚                                   â”‚
â”‚  â”€â”€ å±é™ºãªæ“ä½œ â”€â”€                  â”‚
â”‚  [ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–]              â”‚
â”‚  [ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡]     â”‚
â”‚  [ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤]                â”‚
â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## APIè¨­è¨ˆ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—

```
GET /api/admin/users?page=1&perPage=10&role=&status=&search=
```

**èªå¯:** ADMIN ã®ã¿
**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```json
{
  "data": [
    {
      "id": "clx...",
      "email": "yamada@example.com",
      "name": "å±±ç”° å¤ªéƒ",
      "role": "ADMIN",
      "status": "active",
      "authProvider": "google",
      "lastLoginAt": "2026-02-22T10:30:00Z",
      "createdAt": "2026-01-01T00:00:00Z",
      "invitedBy": null
    }
  ],
  "meta": {
    "total": 12,
    "page": 1,
    "perPage": 10
  }
}
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‹›å¾…

```
POST /api/admin/users/invite
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

```json
{
  "email": "newuser@example.com",
  "name": "æ–°è¦ ãƒ¦ãƒ¼ã‚¶ãƒ¼",
  "role": "VIEWER",
  "authMethod": "email"
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**

1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
2. `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã« status=`invited` ã§ä½œæˆ
3. `authMethod === "email"` ã®å ´åˆ:
   - ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ â†’ bcryptãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜
   - æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´URLï¼‰
4. `authMethod === "google"` ã®å ´åˆ:
   - æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒ­ã‚°ã‚¤ãƒ³URL ã®ã¿ã€åˆå›Google SSOæ™‚ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç´ä»˜ã‘ï¼‰

### ãƒ­ãƒ¼ãƒ«å¤‰æ›´

```
PUT /api/admin/users/:id/role
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

```json
{
  "role": "EDITOR"
}
```

**åˆ¶ç´„:**
- è‡ªåˆ†è‡ªèº«ã®ãƒ­ãƒ¼ãƒ«ã¯å¤‰æ›´ä¸å¯ï¼ˆèª¤æ“ä½œé˜²æ­¢ï¼‰
- æœ€å¾Œã®ADMINãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«é™æ ¼ã¯ä¸å¯
- å¤‰æ›´æ™‚ã«å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ãƒ¡ãƒ¼ãƒ«é€šçŸ¥

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–

```
PUT /api/admin/users/:id/deactivate
```

**å‡¦ç†:**
- `is_active = false` ã«æ›´æ–°
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å…¨ã¦ç„¡åŠ¹åŒ–
- ãƒ­ã‚°ã‚¤ãƒ³ä¸å¯ã«ãªã‚‹ï¼ˆGoogle SSO / Email/PW ä¸¡æ–¹ï¼‰

### ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤

```
DELETE /api/admin/users/:id
```

**åˆ¶ç´„:**
- ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆï¼ˆ`deleted_at` ã«æ—¥æ™‚ã‚’è¨­å®šã€30æ—¥å¾Œã«ç‰©ç†å‰Šé™¤ãƒãƒƒãƒï¼‰
- è‡ªåˆ†è‡ªèº«ã¯å‰Šé™¤ä¸å¯
- æœ€å¾Œã®ADMINã¯å‰Šé™¤ä¸å¯
- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¿…é ˆï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ç¢ºèªï¼‰

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼ˆç®¡ç†è€…æ“ä½œï¼‰

```
POST /api/admin/users/:id/reset-password
```

**å‡¦ç†:**
- ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ â†’ å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- ç®¡ç†è€…ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è‡ªä½“ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã§ããªã„ï¼ˆã‚¼ãƒ­çŸ¥è­˜ï¼‰

---

## æ‹›å¾…ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    actor Admin
    participant UI as æ¨©é™ç®¡ç†ç”»é¢
    participant API as API
    participant DB as DB
    participant Mail as ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    actor NewUser as æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼

    Admin->>UI: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‹›å¾…" ã‚¯ãƒªãƒƒã‚¯
    Admin->>UI: ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ­ãƒ¼ãƒ«ãƒ»èªè¨¼æ–¹å¼ã‚’å…¥åŠ›
    UI->>API: POST /api/admin/users/invite
    API->>DB: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ (status: invited)

    alt Email & Password
        API->>API: ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ + bcryptãƒãƒƒã‚·ãƒ¥åŒ–
        API->>DB: passwordHash ã‚’ä¿å­˜
        API->>Mail: æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ï¼ˆä»®PW + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´URLï¼‰
        Mail->>NewUser: ãƒ¡ãƒ¼ãƒ«å—ä¿¡
        NewUser->>UI: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´URL ã‚¯ãƒªãƒƒã‚¯
        NewUser->>API: æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
        API->>DB: passwordHash æ›´æ–° + status: active
    else Google SSO
        API->>Mail: æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ï¼ˆãƒ­ã‚°ã‚¤ãƒ³URLï¼‰
        Mail->>NewUser: ãƒ¡ãƒ¼ãƒ«å—ä¿¡
        NewUser->>UI: ãƒ­ã‚°ã‚¤ãƒ³URL â†’ Google SSO
        API->>DB: accounts ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç´ä»˜ã‘ + status: active
    end
```

---

## æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«ï¼‰

```typescript
// src/middleware.ts
import { auth } from '@/lib/auth'
import { NextResponse } from 'next/server'

export default auth((req) => {
  const { pathname } = req.nextUrl

  // ç®¡ç†è€…ãƒšãƒ¼ã‚¸: ADMIN ã®ã¿
  if (pathname.startsWith('/settings/users') || pathname.startsWith('/api/admin/')) {
    if (req.auth?.user?.role !== 'ADMIN') {
      return NextResponse.redirect(new URL('/dashboard', req.url))
    }
  }

  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆ
  if (pathname.startsWith('/dashboard')) {
    if (!req.auth?.user) {
      return NextResponse.redirect(new URL('/login', req.url))
    }
  }

  return NextResponse.next()
})
```

### APIãƒ¬ãƒ™ãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼

```typescript
// src/lib/api-auth.ts
import { auth } from '@/lib/auth'
import { NextResponse } from 'next/server'
import type { UserRole } from '@prisma/client'

export async function requireRole(requiredRole: UserRole) {
  const session = await auth()

  if (!session?.user) {
    return NextResponse.json(
      { type: 'UNAUTHORIZED', title: 'èªè¨¼ãŒå¿…è¦ã§ã™', status: 401, detail: '' },
      { status: 401 },
    )
  }

  const roleHierarchy: Record<UserRole, number> = {
    ADMIN: 3,
    EDITOR: 2,
    VIEWER: 1,
  }

  if (roleHierarchy[session.user.role] < roleHierarchy[requiredRole]) {
    return NextResponse.json(
      { type: 'FORBIDDEN', title: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', status: 403, detail: '' },
      { status: 403 },
    )
  }

  return null // æ¨©é™OK
}
```

---

## Claude Codeå®Ÿè£…ã‚¬ã‚¤ãƒ‰

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â””â”€â”€ users/
â”‚   â”‚       â”œâ”€â”€ page.tsx              # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢
â”‚   â”‚       â””â”€â”€ components/
â”‚   â”‚           â”œâ”€â”€ user-table.tsx     # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
â”‚   â”‚           â”œâ”€â”€ invite-modal.tsx   # æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ«
â”‚   â”‚           â”œâ”€â”€ user-detail-panel.tsx # è©³ç´°ãƒ‘ãƒãƒ«
â”‚   â”‚           â””â”€â”€ role-selector.tsx  # ãƒ­ãƒ¼ãƒ«é¸æŠã‚»ãƒ¬ã‚¯ã‚¿
â”‚   â””â”€â”€ api/admin/
â”‚       â””â”€â”€ users/
â”‚           â”œâ”€â”€ route.ts              # GET (ä¸€è¦§), POST (æ‹›å¾…)
â”‚           â”œâ”€â”€ [id]/
â”‚           â”‚   â”œâ”€â”€ route.ts          # GET (è©³ç´°), DELETE
â”‚           â”‚   â”œâ”€â”€ role/route.ts     # PUT (ãƒ­ãƒ¼ãƒ«å¤‰æ›´)
â”‚           â”‚   â”œâ”€â”€ deactivate/route.ts # PUT (ç„¡åŠ¹åŒ–)
â”‚           â”‚   â””â”€â”€ reset-password/route.ts # POST (PWãƒªã‚»ãƒƒãƒˆ)
â”‚           â””â”€â”€ invite/route.ts       # POST (æ‹›å¾…)
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ api-auth.ts                   # æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼
â””â”€â”€ middleware.ts                      # ãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«èªå¯
```

### å®Ÿè£…é †åº

1. `src/lib/api-auth.ts` æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼ä½œæˆ
2. `src/middleware.ts` ã« `/settings/users` ã¨ `/api/admin/` ã®ä¿è­·ã‚’è¿½åŠ 
3. `src/app/api/admin/users/route.ts` ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ»æ‹›å¾…API
4. `src/app/api/admin/users/[id]/role/route.ts` ãƒ­ãƒ¼ãƒ«å¤‰æ›´API
5. `src/app/settings/users/page.tsx` ç®¡ç†ç”»é¢UI
6. `src/app/settings/users/components/*.tsx` å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
7. ãƒ†ã‚¹ãƒˆä½œæˆï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ã®å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆå¿…é ˆï¼‰

### ãƒ†ã‚¹ãƒˆè¦³ç‚¹

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ |
|------------|---------|
| ViewerãŒGET /api/admin/usersã«ã‚¢ã‚¯ã‚»ã‚¹ | 403 Forbidden |
| EditorãŒPUT /api/admin/users/:id/roleã«ã‚¢ã‚¯ã‚»ã‚¹ | 403 Forbidden |
| AdminãŒViewerã‚’Editorã«å¤‰æ›´ | 200 OK + ãƒ­ãƒ¼ãƒ«æ›´æ–° |
| AdminãŒè‡ªåˆ†è‡ªèº«ã®ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´ | 400 Bad Request |
| æœ€å¾Œã®Adminã®ãƒ­ãƒ¼ãƒ«é™æ ¼ | 400 Bad Request |
| AdminãŒå­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ“ä½œ | 404 Not Found |
| æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆEmailèªè¨¼ï¼‰ | 201 Created + ãƒ¡ãƒ¼ãƒ«é€ä¿¡ |
| é‡è¤‡ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ‹›å¾… | 409 Conflict |
